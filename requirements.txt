import random
import streamlit as st

# =========================
# 1. é é¢è¨­å®š (é‡å° MacBook Retina é¡¯ç¤ºå„ªåŒ–)
# =========================
st.set_page_config(page_title="AI é æ¸¬è»¸ç©©å®šç‰ˆ", layout="wide")

st.markdown("""
<style>
    .axis-box { font-size:40px; font-weight:900; text-align:center; padding:25px; border-radius:20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    .round-info { 
        background: #262730; 
        color: #ffffff; 
        padding: 10px 20px; 
        border-radius: 10px; 
        font-size: 20px; 
        font-weight: bold; 
        border: 1px solid #444;
        display: inline-block;
        margin-bottom: 15px;
    }
    .bead {
        width: 42px; height: 42px; line-height: 42px;
        border-radius: 50%; text-align: center; font-weight: bold;
        margin: 5px auto; color: white;
        box-shadow: inset -2px -2px 4px rgba(0,0,0,0.2);
    }
</style>
""", unsafe_allow_html=True)

st.title("ğŸ¯ ç™¾å®¶æ¨‚é æ¸¬è»¸ç³»çµ± Pro (ç©©å®šé‹ç®—ç‰ˆ)")

# =========================
# 2. ç‹€æ…‹åˆå§‹åŒ–
# =========================
if "history" not in st.session_state:
    st.session_state.history = []

if "shoe" not in st.session_state:
    # åˆå§‹åŒ– 8 å‰¯ç‰Œ
    deck = [1,2,3,4,5,6,7,8,9,0,0,0,0] * 4
    st.session_state.shoe = deck * 8
    random.shuffle(st.session_state.shoe)

# å·¥å…·ï¼šçµæœé¡è‰²
def result_color(v):
    return "#1c83e1" if v == "é–’" else "#ff4b4b" if v == "èŠ" else "#28a745"

# =========================
# 3. ç©©å®šç‰ˆ Monte Carlo å‹ç‡è¨ˆç®—
# =========================
def get_stable_monte_carlo(sim=10000):
    shoe = st.session_state.shoe
    if len(shoe) < 12:
        return 0.493, 0.507

    # é‡è¦ï¼šä½¿ç”¨ç›®å‰çš„æ­·å²é•·åº¦ä½œç‚ºéš¨æ©Ÿç¨®å­ï¼Œç¢ºä¿åªè¦å±€æ•¸ä¸è®Šï¼Œé æ¸¬çµæœå°±ä¸æœƒè®Š
    seed_val = len(st.session_state.history)
    rng = random.Random(seed_val)
    
    p_win, b_win = 0, 0
    for _ in range(sim):
        s = rng.sample(shoe, 6)
        pv = (s[0] + s[1]) % 10
        bv = (s[2] + s[3]) % 10
        if pv <= 5: pv = (pv + s[4]) % 10
        if bv <= 5: bv = (bv + s[5]) % 10
        if pv > bv: p_win += 1
        elif bv > pv: b_win += 1

    total = p_win + b_win
    return (0.5, 0.5) if total == 0 else (p_win / total, b_win / total)

# =========================
# 4. æŒ‡æ¨™èˆ‡ç‰©ç†é‡è¨ˆç®—
# =========================
p_prob, b_prob = get_stable_monte_carlo()
delta = (b_prob - p_prob) * 100

# çœŸå¯¦è¨˜æ•¸ (EOR)
EOR = {1:-0.6, 2:-0.4, 3:-0.7, 4:-1.2, 5:0.8, 6:0.6, 7:0.3, 8:0.1, 9:-0.1, 0:0.2}
score = sum(EOR.get(c, 0) for c in st.session_state.shoe)
tc = score / max(len(st.session_state.shoe) / 52, 0.5)

# æ¨¡æ“¬ç‰©ç†é‡ (ä½¿ç”¨å›ºå®šç®—æ³•é¿å…è·³å‹•)
# é€™è£¡å°‡ delta èˆ‡ TC é€²è¡Œæ¨™æº–åŒ–æ¬Šé‡è¨ˆç®—
d_norm = max(min(delta / 2, 1), -1)
tc_norm = max(min(tc / 3, 1), -1)
axis_score = d_norm * 0.6 + tc_norm * 0.4 # ç°¡åŒ–æ¬Šé‡ï¼Œç¢ºä¿åæ‡‰éˆæ•ä¸”ç©©å®š
axis_0_10 = round((axis_score + 1) * 5, 1)

# =========================
# 5. é¡¯ç¤ºé æ¸¬è»¸
# =========================
if axis_0_10 >= 6.5:
    label, color = "å¼·çƒˆåå‘ã€èŠã€‘", "#ff4b4b"
elif axis_0_10 >= 5.5:
    label, color = "å¾®å¹…åå‘ã€èŠã€‘", "#ff4b4b"
elif axis_0_10 <= 3.5:
    label, color = "å¼·çƒˆåå‘ã€é–’ã€‘", "#1c83e1"
elif axis_0_10 <= 4.5:
    label, color = "å¾®å¹…åå‘ã€é–’ã€‘", "#1c83e1"
else:
    label, color = "ä¸­æ€§è§€æœ›", "#555"

st.markdown(
    f"<div class='axis-box' style='background:{color}; color:white;'>"
    f"é æ¸¬è»¸åˆ†æ•¸ï¼š{axis_0_10} / 10<br><span style='font-size:24px;'>{label}</span></div>",
    unsafe_allow_html=True
)

# =========================
# 6. æ•¸æ“šé¢æ¿
# =========================
st.write("### æ•¸æ“šç›£æ§")
c1, c2, c3, c4, c5 = st.columns(5)
c1.metric("é–’é ä¼°å‹ç‡", f"{p_prob*100:.2f}%")
c2.metric("èŠé ä¼°å‹ç‡", f"{b_prob*100:.2f}%")
c3.metric("Î” å‹ç‡å·®", f"{delta:+.2f}%")
c4.metric("TC çœŸå¯¦è¨˜æ•¸", f"{tc:.2f}")
c5.metric("ç³»çµ±ç‹€æ…‹", "ç©©å®šç›£æ§ä¸­")

# =========================
# 7. æ“ä½œæŒ‰éˆ•
# =========================
st.divider()
total_rounds = len(st.session_state.history)
st.markdown(f"<div class='round-info'>ç›®å‰å±€æ•¸ï¼šç¬¬ {total_rounds} å±€</div>", unsafe_allow_html=True)

b1, b2, b3, b4, b5 = st.columns(5)

def record_result(r):
    st.session_state.history.append(r)
    for _ in range(6):
        if st.session_state.shoe:
            st.session_state.shoe.pop()
    st.rerun()

def undo_step():
    if st.session_state.history:
        st.session_state.history.pop()
        # å›é€€æ™‚è£œå›ç‰Œå † (å‡è¨­ä¸€å±€ç”¨ 6 å¼µ)
        deck = [1,2,3,4,5,6,7,8,9,0,0,0,0]
        for _ in range(6):
            st.session_state.shoe.append(random.choice(deck))
        st.rerun()

b1.button("ğŸ”µ ç´€éŒ„ã€é–’ã€‘", on_click=lambda: record_result("é–’"), use_container_width=True)
b2.button("ğŸ”´ ç´€éŒ„ã€èŠã€‘", on_click=lambda: record_result("èŠ"), use_container_width=True)
b3.button("ğŸŸ¢ ç´€éŒ„ã€å’Œã€‘", on_click=lambda: record_result("å’Œ"), use_container_width=True)
b4.button("â†©ï¸ å›é€€ä¸€æ­¥", on_click=undo_step, use_container_width=True)
b5.button("ğŸ”„ é‡æ–°æ´—ç‰Œ", on_click=lambda: st.session_state.clear(), use_container_width=True)

# =========================
# 8. ç ç›¤è·¯é¡¯ç¤º
# =========================
if st.session_state.history:
    st.write("### ç ç›¤è·¯è¶¨å‹¢")
    rows = [st.session_state.history[i:i+6] for i in range(0, len(st.session_state.history), 6)]
    for r in rows:
        cols = st.columns(12)
        for i, v in enumerate(r):
            cols[i].markdown(f"<div class='bead' style='background:{result_color(v)};'>{v}</div>", unsafe_allow_html=True)
